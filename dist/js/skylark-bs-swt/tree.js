/**
 * skylark-bs-swt - The skylark bootstrap standard widget tookit
 * @author Hudaokeji, Inc.
 * @version v0.9.0-beta
 * @link https://github.com/skylarkui/skylark-bs-swt/
 * @license MIT
 */
define(["skylark-utils/langx","skylark-utils/browser","skylark-utils/eventer","skylark-utils/noder","skylark-utils/geom","skylark-utils/query"],function(e,t,n,r,l,i){function a(e,t){e.addClass("tree-selected"),"item"===e.data("type")&&t.hasClass("fueluxicon-bullet")&&t.removeClass("fueluxicon-bullet").addClass("glyphicon-ok")}function s(e,t){e.removeClass("tree-selected"),"item"===e.data("type")&&t.hasClass("glyphicon-ok")&&t.removeClass("glyphicon-ok").addClass("fueluxicon-bullet")}function o(e,t,n){return i.each(n.$elements,function(e,r){var l=i(r);l[0]!==t.$element[0]&&n.dataForEvent.push(i(l).data())}),t.$element.hasClass("tree-selected")?(s(t.$element,t.$icon),n.eventType="deselected"):(a(t.$element,t.$icon),n.eventType="selected",n.dataForEvent.push(t.elementData)),n}function d(e,t,n){return n.$elements[0]!==t.$element[0]?(e.deselectAll(e.$element),a(t.$element,t.$icon),n.eventType="selected",n.dataForEvent=[t.elementData]):(s(t.$element,t.$icon),n.eventType="deselected",n.dataForEvent=[]),n}var c=i.fn.tree,f=function(t,n){this.$element=i(t),this.options=e.mixin({},i.fn.tree.defaults,n),this.$element.attr("tabindex","0"),this.options.itemSelect&&this.$element.on("click.fu.tree",".tree-item",i.proxy(function(e){this.selectItem(e.currentTarget)},this)),this.$element.on("click.fu.tree",".tree-branch-name",i.proxy(function(e){this.toggleFolder(e.currentTarget)},this)),this.$element.on("click.fu.tree",".tree-overflow",i.proxy(function(e){this.populate(i(e.currentTarget))},this)),this.options.folderSelect&&(this.$element.addClass("tree-folder-select"),this.$element.off("click.fu.tree",".tree-branch-name"),this.$element.on("click.fu.tree",".icon-caret",i.proxy(function(e){this.toggleFolder(i(e.currentTarget).parent())},this)),this.$element.on("click.fu.tree",".tree-branch-name",i.proxy(function(e){this.selectFolder(i(e.currentTarget))},this))),this.$element.on("focus",function(){var e=i(this);u(e,e)}),this.$element.on("keydown",function(e){return p(i(this),e)}),this.render()};f.prototype={constructor:f,deselectAll:function(e){var t=e||this.$element,n=i(t).find(".tree-selected");return n.each(function(e,t){var n=i(t);$(n),s(n,n.find(".glyphicon"))}),n},destroy:function(){return this.$element.find("li:not([data-template])").remove(),this.$element.remove(),this.$element[0].outerHTML},render:function(){this.populate(this.$element)},populate:function(e,t){var n=this,r=e.hasClass("tree-overflow"),l=e.hasClass("tree")?e:e.parent(),a=l.hasClass("tree");r&&!a&&(l=l.parent());var s=l.data();r&&(s.overflow=e.data());var o=t||!1;r&&(a?e.replaceWith(l.find("> .tree-loader").remove()):e.remove());var d=l.find(".tree-loader:last");o===!1&&d.removeClass("hide hidden"),this.options.dataSource(s?s:{},function(e){i.each(e.data,function(e,t){var r=t.type;"folder"===t.type&&(r="branch");var s=n.$element.find("[data-template=tree"+r+"]:eq(0)").clone().removeClass("hide hidden").removeData("template").removeAttr("data-template");s.find(".tree-"+r+"-name > .tree-label").html(t.text||t.name),s.data(t);var o=t.attr||t.dataAttributes||[];i.each(o,function(e,t){switch(e){case"cssClass":case"class":case"className":s.addClass(t);break;case"data-icon":s.find(".icon-item").removeClass().addClass("icon-item "+t),s.attr(e,t);break;case"id":s.attr(e,t),s.attr("aria-labelledby",t+"-label"),s.find(".tree-branch-name > .tree-label").attr("id",t+"-label");break;default:s.attr(e,t)}}),a?l.append(s):l.find(".tree-branch-children:eq(0)").append(s)}),l.find(".tree-loader").addClass("hidden"),n.$element.trigger("loaded.fu.tree",l)})},selectTreeNode:function(e,t){var n={};n.$element=i(e);var r={};r.$elements=this.$element.find(".tree-selected"),r.dataForEvent=[],"folder"===t?(n.$element=n.$element.closest(".tree-branch"),n.$icon=n.$element.find(".icon-folder")):n.$icon=n.$element.find(".icon-item"),n.elementData=n.$element.data(),v(n.$element),r=this.options.multiSelect?o(this,n,r):d(this,n,r),m(this.$element,n.$element),this.$element.trigger(r.eventType+".fu.tree",{target:n.elementData,selected:r.dataForEvent}),n.$element.trigger("updated.fu.tree",{selected:r.dataForEvent,item:n.$element,eventType:r.eventType})},discloseFolder:function(e){var t=i(e),n=t.closest(".tree-branch"),r=n.find(".tree-branch-children"),l=r.eq(0);n.addClass("tree-open"),n.attr("aria-expanded","true"),l.removeClass("hide hidden"),n.find("> .tree-branch-header .icon-folder").eq(0).removeClass("glyphicon-folder-close").addClass("glyphicon-folder-open");var a=this.$element,s=function(){a.trigger("disclosedFolder.fu.tree",n.data())};r.children().length?s():(a.one("loaded.fu.tree",s),this.populate(r))},closeFolder:function(e){var t=i(e),n=t.closest(".tree-branch"),r=n.find(".tree-branch-children"),l=r.eq(0);n.removeClass("tree-open"),n.attr("aria-expanded","false"),l.addClass("hidden"),n.find("> .tree-branch-header .icon-folder").eq(0).removeClass("glyphicon-folder-open").addClass("glyphicon-folder-close"),this.options.cacheItems||l.empty(),this.$element.trigger("closed.fu.tree",n.data())},toggleFolder:function(e){var t=i(e);t.find(".glyphicon-folder-close").length?this.discloseFolder(e):t.find(".glyphicon-folder-open").length&&this.closeFolder(e)},selectFolder:function(e){this.options.folderSelect&&this.selectTreeNode(e,"folder")},selectItem:function(e){this.options.itemSelect&&this.selectTreeNode(e,"item")},selectedItems:function(){var e=this.$element.find(".tree-selected"),t=[];return i.each(e,function(e,n){t.push(i(n).data())}),t},collapse:function(){var e=this,t=[],n=function r(n,l){t.push(l),0===e.$element.find(".tree-branch.tree-open:not('.hidden, .hide')").length&&(e.$element.trigger("closedAll.fu.tree",{tree:e.$element,reportedClosed:t}),e.$element.off("loaded.fu.tree",e.$element,r))};e.$element.on("closed.fu.tree",n),e.$element.find(".tree-branch.tree-open:not('.hidden, .hide')").each(function(){e.closeFolder(this)})},discloseVisible:function(){var e=this,t=e.$element.find(".tree-branch:not('.tree-open, .hidden, .hide')"),n=[],r=function l(r,i){n.push(i),n.length===t.length&&(e.$element.trigger("disclosedVisible.fu.tree",{tree:e.$element,reportedOpened:n}),e.$element.off("loaded.fu.tree",e.$element,l))};e.$element.on("loaded.fu.tree",r),e.$element.find(".tree-branch:not('.tree-open, .hidden, .hide')").each(function(){e.discloseFolder(i(this).find(".tree-branch-header"))})},discloseAll:function(){var e=this;"undefined"==typeof e.$element.data("disclosures")&&e.$element.data("disclosures",0);var t=e.options.disclosuresUpperLimit>=1&&e.$element.data("disclosures")>=e.options.disclosuresUpperLimit,n=0===e.$element.find(".tree-branch:not('.tree-open, .hidden, .hide')").length;if(n)e.$element.trigger("disclosedAll.fu.tree",{tree:e.$element,disclosures:e.$element.data("disclosures")}),e.options.cacheItems||e.$element.one("closeAll.fu.tree",function(){e.$element.data("disclosures",0)});else{if(t&&(e.$element.trigger("exceededDisclosuresLimit.fu.tree",{tree:e.$element,disclosures:e.$element.data("disclosures")}),!e.$element.data("ignore-disclosures-limit")))return;e.$element.data("disclosures",e.$element.data("disclosures")+1),e.$element.one("disclosedVisible.fu.tree",function(){e.discloseAll()}),e.discloseVisible()}},refreshFolder:function(e){var t=e.closest(".tree-branch"),n=t.find(".tree-branch-children");n.eq(0).empty(),t.hasClass("tree-open")?this.populate(n,!1):this.populate(n,!0),this.$element.trigger("refreshedFolder.fu.tree",t.data())}},f.prototype.closeAll=f.prototype.collapse,f.prototype.openFolder=f.prototype.discloseFolder,f.prototype.getValue=f.prototype.selectedItems;var h=function(e,t){e.attr("tabindex",-1),e.find("li").attr("tabindex",-1),t&&t.length>0&&t.attr("tabindex",0)},u=function(e,t){var n=t.find(".tree-selected:first");n.length<=0&&(n=t.find('li:not(".hidden"):first')),m(e,n)},m=function(e,t){h(e,t),e.attr("aria-activedescendant",t.attr("id")),t.focus(),e.trigger("setFocus.fu.tree",t)},p=function(e,t){if(t.isDefaultPrevented()||t.isPropagationStopped())return!1;var n=t.originalEvent.target,r=i(n),l=r.hasClass("tree-open"),a=!1,s=!0,o=function(){e.trigger("keyboardNavigated.fu.tree",t,r)};switch(t.which){case 13:case 32:var d=e.hasClass("tree-folder-select"),c=r.hasClass("tree-branch"),f=r.hasClass("tree-item");s=!1,c?d?(e.one("selected.fu.tree deselected.fu.tree",o),e.tree("selectFolder",r.find(".tree-branch-header")[0])):(e.one("loaded.fu.tree closed.fu.tree",o),e.tree("toggleFolder",r.find(".tree-branch-header")[0])):f?(e.one("selected.fu.tree",o),e.tree("selectItem",r)):(h=i(r.prevAll().not(".hidden")[0]),r.click(),e.one("loaded.fu.tree",function(){v=i(h.nextAll().not(".hidden")[0]),m(e,v),o()})),a=!0;break;case 35:m(e,e.find('li:not(".hidden"):last')),a=!0;break;case 36:m(e,e.find('li:not(".hidden"):first')),a=!0;break;case 37:l?(s=!1,e.one("closed.fu.tree",o),e.tree("closeFolder",n)):m(e,i(r.parents("li")[0])),a=!0;break;case 38:var h=[];if(h=i(r.prevAll().not(".hidden")[0]),h.hasClass("tree-open")){var p=h.find('li:not(".hidden"):last');p.length>0&&(h=i(p[0]))}h.length<1&&(h=i(r.parents("li")[0])),m(e,h),a=!0;break;case 39:l?u(e,r):(s=!1,e.one("disclosed.fu.tree",o),e.tree("discloseFolder",n)),a=!0;break;case 40:var v=i(r.find('li:not(".hidden"):first')[0]);(!l||v.length<=0)&&(v=i(r.nextAll().not(".hidden")[0])),v.length<1&&(v=i(i(r.parents("li")[0]).nextAll().not(".hidden")[0])),m(e,v),a=!0;break;default:return!0}return a&&(t.preventDefault(),t.stopPropagation(),s&&o()),!0},v=function(e){e.attr("aria-selected",!0)},$=function(e){e.attr("aria-selected",!1)};i.fn.tree=function(e){var t,n=Array.prototype.slice.call(arguments,1),r=this.each(function(){var r=i(this),l=r.data("fu.tree"),a="object"==typeof e&&e;l||(r.data("fu.tree",l=new f(this,a)),r.trigger("initialized.fu.tree")),"string"==typeof e&&(t=l[e].apply(l,n))});return void 0===t?r:t};var g=function b(e,t){var n=i.isEmptyObject(e);if(n)return t;if(void 0===t)return!1;for(var r=0;r<t.length;r++){var l=t[r];if(l.attr&&e.attr&&l.attr.id===e.attr.id)return l.children;if(l.children){var a=b(e,l.children);if(a)return a}}return!1};i.fn.tree.defaults={staticData:[],dataSource:function(e,t){if(this.staticData.length>0){var n=g(e,this.staticData);t({data:n})}},multiSelect:!1,cacheItems:!0,folderSelect:!0,itemSelect:!0,disclosuresUpperLimit:0},i.fn.tree.Constructor=f,i.fn.tree.noConflict=function(){return i.fn.tree=c,this}});
//# sourceMappingURL=sourcemaps/tree.js.map
