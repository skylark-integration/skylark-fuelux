/**
 * skylark-bs-swt - The skylark bootstrap standard widget tookit
 * @author Hudaokeji, Inc.
 * @version v0.9.0-beta
 * @link https://github.com/skylarkui/skylark-bs-swt/
 * @license MIT
 */
define(["skylark-utils/langx","skylark-utils/browser","skylark-utils/eventer","skylark-utils/noder","skylark-utils/geom","skylark-utils/velm","skylark-utils/query","../../tree","../../sbswt"],function(e,t,a,n,o,i,s,r,c){"use strict";if(!s.jstree.plugins.contextmenu)return s.jstree.defaults.contextmenu={select_node:!0,show_at_node:!0,items:function(e,t){return{create:{separator_before:!1,separator_after:!0,_disabled:!1,label:"Create",action:function(e){var t=s.jstree.reference(e.reference),a=t.get_node(e.reference);t.create_node(a,{},"last",function(e){try{t.edit(e)}catch(a){setTimeout(function(){t.edit(e)},0)}})}},rename:{separator_before:!1,separator_after:!1,_disabled:!1,label:"Rename",action:function(e){var t=s.jstree.reference(e.reference),a=t.get_node(e.reference);t.edit(a)}},remove:{separator_before:!1,icon:!1,separator_after:!1,_disabled:!1,label:"Delete",action:function(e){var t=s.jstree.reference(e.reference),a=t.get_node(e.reference);t.is_selected(a)?t.delete_node(t.get_selected()):t.delete_node(a)}},ccp:{separator_before:!0,icon:!1,separator_after:!1,label:"Edit",action:!1,submenu:{cut:{separator_before:!1,separator_after:!1,label:"Cut",action:function(e){var t=s.jstree.reference(e.reference),a=t.get_node(e.reference);t.is_selected(a)?t.cut(t.get_top_selected()):t.cut(a)}},copy:{separator_before:!1,icon:!1,separator_after:!1,label:"Copy",action:function(e){var t=s.jstree.reference(e.reference),a=t.get_node(e.reference);t.is_selected(a)?t.copy(t.get_top_selected()):t.copy(a)}},paste:{separator_before:!1,icon:!1,_disabled:function(e){return!s.jstree.reference(e.reference).can_paste()},separator_after:!1,label:"Paste",action:function(e){var t=s.jstree.reference(e.reference),a=t.get_node(e.reference);t.paste(a)}}}}}}},s.jstree.plugins.contextmenu=function(e,t){this.bind=function(){t.bind.call(this);var e,a,n=0,o=null;this.element.on("init.jstree loading.jstree ready.jstree",s.proxy(function(){this.get_container_ul().addClass("jstree-contextmenu")},this)).on("contextmenu.jstree",".jstree-anchor",s.proxy(function(e,t){"input"!==e.target.tagName.toLowerCase()&&(e.preventDefault(),n=e.ctrlKey?+new Date:0,(t||o)&&(n=+new Date+1e4),o&&clearTimeout(o),this.is_loading(e.currentTarget)||this.show_contextmenu(e.currentTarget,e.pageX,e.pageY,e))},this)).on("click.jstree",".jstree-anchor",s.proxy(function(e){this._data.contextmenu.visible&&(!n||+new Date-n>250)&&s.vakata.context.hide(),n=0},this)).on("touchstart.jstree",".jstree-anchor",function(t){t.originalEvent&&t.originalEvent.changedTouches&&t.originalEvent.changedTouches[0]&&(e=t.originalEvent.changedTouches[0].clientX,a=t.originalEvent.changedTouches[0].clientY,o=setTimeout(function(){s(t.currentTarget).trigger("contextmenu",!0)},750))}).on("touchmove.vakata.jstree",function(t){o&&t.originalEvent&&t.originalEvent.changedTouches&&t.originalEvent.changedTouches[0]&&(Math.abs(e-t.originalEvent.changedTouches[0].clientX)>10||Math.abs(a-t.originalEvent.changedTouches[0].clientY)>10)&&(clearTimeout(o),s.vakata.context.hide())}).on("touchend.vakata.jstree",function(e){o&&clearTimeout(o)}),s(document).on("context_hide.vakata.jstree",s.proxy(function(e,t){this._data.contextmenu.visible=!1,s(t.reference).removeClass("jstree-context")},this))},this.teardown=function(){this._data.contextmenu.visible&&s.vakata.context.hide(),t.teardown.call(this)},this.show_contextmenu=function(e,t,a,n){if(e=this.get_node(e),!e||e.id===s.jstree.root)return!1;var o=this.settings.contextmenu,i=this.get_node(e,!0),r=i.children(".jstree-anchor"),c=!1,l=!1;(o.show_at_node||void 0===t||void 0===a)&&(c=r.offset(),t=c.left,a=c.top+this._data.core.li_height),this.settings.contextmenu.select_node&&!this.is_selected(e)&&this.activate_node(e,n),l=o.items,s.isFunction(l)&&(l=l.call(this,e,s.proxy(function(n){this._show_contextmenu(e,t,a,n)},this))),s.isPlainObject(l)&&this._show_contextmenu(e,t,a,l)},this._show_contextmenu=function(e,t,a,n){var o=this.get_node(e,!0),i=o.children(".jstree-anchor");s(document).one("context_show.vakata.jstree",s.proxy(function(e,t){var a="jstree-contextmenu jstree-"+this.get_theme()+"-contextmenu";s(t.element).addClass(a),i.addClass("jstree-context")},this)),this._data.contextmenu.visible=!0,s.vakata.context.show(i,{x:t,y:a},n),this.trigger("show_contextmenu",{node:e,x:t,y:a})}},function(e){var t=!1,a={element:!1,reference:!1,position_x:0,position_y:0,items:[],html:"",is_visible:!1};e.vakata.context={settings:{hide_onmouseleave:0,icons:!0},_trigger:function(t){e(document).trigger("context_"+t+".vakata",{reference:a.reference,element:a.element,position:{x:a.position_x,y:a.position_y}})},_execute:function(t){return t=a.items[t],!(!t||t._disabled&&(!e.isFunction(t._disabled)||t._disabled({item:t,reference:a.reference,element:a.element}))||!t.action)&&t.action.call(null,{item:t,reference:a.reference,element:a.element,position:{x:a.position_x,y:a.position_y}})},_parse:function(t,n){if(!t)return!1;n||(a.html="",a.items=[]);var o,i="",s=!1;return n&&(i+="<ul>"),e.each(t,function(t,n){return!n||(a.items.push(n),!s&&n.separator_before&&(i+="<li class='vakata-context-separator'><a href='#' "+(e.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;</a></li>"),s=!1,i+="<li class='"+(n._class||"")+(n._disabled===!0||e.isFunction(n._disabled)&&n._disabled({item:n,reference:a.reference,element:a.element})?" vakata-contextmenu-disabled ":"")+"' "+(n.shortcut?" data-shortcut='"+n.shortcut+"' ":"")+">",i+="<a href='#' rel='"+(a.items.length-1)+"' "+(n.title?"title='"+n.title+"'":"")+">",e.vakata.context.settings.icons&&(i+="<i ",n.icon&&(i+=n.icon.indexOf("/")!==-1||n.icon.indexOf(".")!==-1?" style='background:url(\""+n.icon+"\") center center no-repeat' ":" class='"+n.icon+"' "),i+="></i><span class='vakata-contextmenu-sep'>&#160;</span>"),i+=(e.isFunction(n.label)?n.label({item:t,reference:a.reference,element:a.element}):n.label)+(n.shortcut?' <span class="vakata-contextmenu-shortcut vakata-contextmenu-shortcut-'+n.shortcut+'">'+(n.shortcut_label||"")+"</span>":"")+"</a>",n.submenu&&(o=e.vakata.context._parse(n.submenu,!0),o&&(i+=o)),i+="</li>",void(n.separator_after&&(i+="<li class='vakata-context-separator'><a href='#' "+(e.vakata.context.settings.icons?"":'style="margin-left:0px;"')+">&#160;</a></li>",s=!0)))}),i=i.replace(/<li class\='vakata-context-separator'\><\/li\>$/,""),n&&(i+="</ul>"),n||(a.html=i,e.vakata.context._trigger("parse")),i.length>10&&i},_show_submenu:function(a){if(a=e(a),a.length&&a.children("ul").length){var n=a.children("ul"),o=a.offset().left,i=o+a.outerWidth(),s=a.offset().top,r=n.width(),c=n.height(),l=e(window).width()+e(window).scrollLeft(),d=e(window).height()+e(window).scrollTop();t?a[i-(r+10+a.outerWidth())<0?"addClass":"removeClass"]("vakata-context-left"):a[i+r>l&&o>l-i?"addClass":"removeClass"]("vakata-context-right"),s+c+10>d&&n.css("bottom","-1px"),a.hasClass("vakata-context-right")?o<r&&n.css("margin-right",o-r):l-i<r&&n.css("margin-left",l-i-r),n.show()}},show:function(n,o,i){var s,r,c,l,d,u,h,v,f=!0;switch(a.element&&a.element.length&&a.element.width(""),f){case!o&&!n:return!1;case!!o&&!!n:a.reference=n,a.position_x=o.x,a.position_y=o.y;break;case!o&&!!n:a.reference=n,s=n.offset(),a.position_x=s.left+n.outerHeight(),a.position_y=s.top;break;case!!o&&!n:a.position_x=o.x,a.position_y=o.y}n&&!i&&e(n).data("vakata_contextmenu")&&(i=e(n).data("vakata_contextmenu")),e.vakata.context._parse(i)&&a.element.html(a.html),a.items.length&&(a.element.appendTo(document.body),r=a.element,c=a.position_x,l=a.position_y,d=r.width(),u=r.height(),h=e(window).width()+e(window).scrollLeft(),v=e(window).height()+e(window).scrollTop(),t&&(c-=r.outerWidth()-e(n).outerWidth(),c<e(window).scrollLeft()+20&&(c=e(window).scrollLeft()+20)),c+d+20>h&&(c=h-(d+20)),l+u+20>v&&(l=v-(u+20)),a.element.css({left:c,top:l}).show().find("a").first().focus().parent().addClass("vakata-context-hover"),a.is_visible=!0,e.vakata.context._trigger("show"))},hide:function(){a.is_visible&&(a.element.hide().find("ul").hide().end().find(":focus").blur().end().detach(),a.is_visible=!1,e.vakata.context._trigger("hide"))}},e(function(){t="rtl"===e(document.body).css("direction");var o=!1;a.element=e("<ul class='vakata-context'></ul>"),a.element.on("mouseenter","li",function(t){t.stopImmediatePropagation(),n.contains(this,t.relatedTarget)||(o&&clearTimeout(o),a.element.find(".vakata-context-hover").removeClass("vakata-context-hover").end(),e(this).siblings().find("ul").hide().end().end().parentsUntil(".vakata-context","li").addBack().addClass("vakata-context-hover"),e.vakata.context._show_submenu(this))}).on("mouseleave","li",function(t){n.contains(this,t.relatedTarget)||e(this).find(".vakata-context-hover").addBack().removeClass("vakata-context-hover")}).on("mouseleave",function(t){e(this).find(".vakata-context-hover").removeClass("vakata-context-hover"),e.vakata.context.settings.hide_onmouseleave&&(o=setTimeout(function(t){return function(){e.vakata.context.hide()}}(this),e.vakata.context.settings.hide_onmouseleave))}).on("click","a",function(t){t.preventDefault(),e(this).blur().parent().hasClass("vakata-context-disabled")||e.vakata.context._execute(e(this).attr("rel"))===!1||e.vakata.context.hide()}).on("keydown","a",function(t){var n=null;switch(t.which){case 13:case 32:t.type="click",t.preventDefault(),e(t.currentTarget).trigger(t);break;case 37:a.is_visible&&(a.element.find(".vakata-context-hover").last().closest("li").first().find("ul").hide().find(".vakata-context-hover").removeClass("vakata-context-hover").end().end().children("a").focus(),t.stopImmediatePropagation(),t.preventDefault());break;case 38:a.is_visible&&(n=a.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").prevAll("li:not(.vakata-context-separator)").first(),n.length||(n=a.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").last()),n.addClass("vakata-context-hover").children("a").focus(),t.stopImmediatePropagation(),t.preventDefault());break;case 39:a.is_visible&&(a.element.find(".vakata-context-hover").last().children("ul").show().children("li:not(.vakata-context-separator)").removeClass("vakata-context-hover").first().addClass("vakata-context-hover").children("a").focus(),t.stopImmediatePropagation(),t.preventDefault());break;case 40:a.is_visible&&(n=a.element.find("ul:visible").addBack().last().children(".vakata-context-hover").removeClass("vakata-context-hover").nextAll("li:not(.vakata-context-separator)").first(),n.length||(n=a.element.find("ul:visible").addBack().last().children("li:not(.vakata-context-separator)").first()),n.addClass("vakata-context-hover").children("a").focus(),t.stopImmediatePropagation(),t.preventDefault());break;case 27:e.vakata.context.hide(),t.preventDefault()}}).on("keydown",function(e){e.preventDefault();var t=a.element.find(".vakata-contextmenu-shortcut-"+e.which).parent();t.parent().not(".vakata-context-disabled")&&t.click()}),e(document).on("mousedown.vakata.jstree",function(t){a.is_visible&&a.element[0]!==t.target&&!n.contains(a.element[0],t.target)&&e.vakata.context.hide()}).on("context_show.vakata.jstree",function(e,n){a.element.find("li:has(ul)").children("a").addClass("vakata-context-parent"),t&&a.element.addClass("vakata-context-rtl").css("direction","rtl"),a.element.find("ul").hide().end()})})}(s),s});
//# sourceMappingURL=../../sourcemaps/plugin/tree/contextmenu.js.map
